



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.1.1">
    
    
      
        <title>Computer Systems II - Notes</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/application.3020aac5.css">
      
        <link rel="stylesheet" href="assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="assets/javascripts/modernizr.01ccdecf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#computer-systems-ii" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="index.html" title="Notes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Notes
            </span>
            <span class="md-header-nav__topic">
              Computer Systems II
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="index.html" title="Notes" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="index.html" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="BodyBuilding.html" title="Body Building and general nutrition" class="md-nav__link">
      Body Building and general nutrition
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Computer Systems II
      </label>
    
    <a href="ComputerSystems2.html" title="Computer Systems II" class="md-nav__link md-nav__link--active">
      Computer Systems II
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#terminology" title="Terminology" class="md-nav__link">
    Terminology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#useful-info" title="Useful Info" class="md-nav__link">
    Useful Info
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interrupt-vectors" title="Interrupt Vectors" class="md-nav__link">
    Interrupt Vectors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sreg" title="SREG" class="md-nav__link">
    SREG
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcnt0" title="TCNT0" class="md-nav__link">
    TCNT0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ocr0a" title="OCR0A" class="md-nav__link">
    OCR0A
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timsk0" title="TIMSK0" class="md-nav__link">
    TIMSK0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tccr0a" title="TCCR0A" class="md-nav__link">
    TCCR0A
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tifr0" title="TIFR0" class="md-nav__link">
    TIFR0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clkpr" title="CLKPR" class="md-nav__link">
    CLKPR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sei" title="sei()" class="md-nav__link">
    sei()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli" title="cli()" class="md-nav__link">
    cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unstructured-notes" title="Unstructured Notes" class="md-nav__link">
    Unstructured Notes
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="DistributedSystemsAndNetworks.html" title="Distributed Systems & Networks" class="md-nav__link">
      Distributed Systems & Networks
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="IntelligentSystems.html" title="Intelligent Systems" class="md-nav__link">
      Intelligent Systems
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="ProgrammingLanguageConcepts.html" title="Programming Language Concepts" class="md-nav__link">
      Programming Language Concepts
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#terminology" title="Terminology" class="md-nav__link">
    Terminology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#useful-info" title="Useful Info" class="md-nav__link">
    Useful Info
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#interrupt-vectors" title="Interrupt Vectors" class="md-nav__link">
    Interrupt Vectors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sreg" title="SREG" class="md-nav__link">
    SREG
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tcnt0" title="TCNT0" class="md-nav__link">
    TCNT0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ocr0a" title="OCR0A" class="md-nav__link">
    OCR0A
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timsk0" title="TIMSK0" class="md-nav__link">
    TIMSK0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tccr0a" title="TCCR0A" class="md-nav__link">
    TCCR0A
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tifr0" title="TIFR0" class="md-nav__link">
    TIFR0
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clkpr" title="CLKPR" class="md-nav__link">
    CLKPR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sei" title="sei()" class="md-nav__link">
    sei()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cli" title="cli()" class="md-nav__link">
    cli()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unstructured-notes" title="Unstructured Notes" class="md-nav__link">
    Unstructured Notes
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="computer-systems-ii">Computer Systems II<a class="headerlink" href="#computer-systems-ii" title="Permanent link">⇦</a></h1>
<details class="success"><summary>University course</summary><p>These notes were made for the University of Southampton COMP2215 module.</p>
</details>
<h2 id="terminology">Terminology<a class="headerlink" href="#terminology" title="Permanent link">⇦</a></h2>
<details class="question"><summary>Vector table</summary><ul>
<li>The vector table contains a set of interrupt handlers which are called when there is an interrupt request</li>
<li>An interrupt handler contained here is often called a vector (direction the program can go)</li>
<li>In AVR-GCC the vector table is <strong>predefined</strong> meaning it directly sets the program counter to jump to executing interrupt code</li>
<li>In AVR-GCC interrupt routines also have a predefined name meaning they will be called automatically as long as they are named appropriately</li>
</ul>
</details>
<h2 id="useful-info">Useful Info<a class="headerlink" href="#useful-info" title="Permanent link">⇦</a></h2>
<details class="tip"><summary>Interrupt Vectors</summary><h3 id="interrupt-vectors">Interrupt Vectors<a class="headerlink" href="#interrupt-vectors" title="Permanent link">⇦</a></h3>
<p>A list of every interrupt vector for AT90USB1286</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADC_vect</td>
<td>ADC conversion complete</td>
</tr>
<tr>
<td>ANALOG_COMP_vect</td>
<td>Analog comparator</td>
</tr>
<tr>
<td>EE_READY_vect</td>
<td>EEPROM ready</td>
</tr>
<tr>
<td>INT0_vect</td>
<td>External Interrupt 0</td>
</tr>
<tr>
<td>INT1_vect</td>
<td>External Interrupt 1</td>
</tr>
<tr>
<td>INT2_vect</td>
<td>External Interrupt 2</td>
</tr>
<tr>
<td>INT3_vect</td>
<td>External Interrupt 3</td>
</tr>
<tr>
<td>INT4_vect</td>
<td>External Interrupt 4</td>
</tr>
<tr>
<td>INT5_vect</td>
<td>External Interrupt 5</td>
</tr>
<tr>
<td>INT6_vect</td>
<td>External Interrupt 6</td>
</tr>
<tr>
<td>INT7_vect</td>
<td>External Interrupt 7</td>
</tr>
<tr>
<td>PCINT0_vect</td>
<td>Pin Change Interrupt 0</td>
</tr>
<tr>
<td>SPI_STC_vect</td>
<td>Serial Transfer Complete</td>
</tr>
<tr>
<td>SPM_READY_vect</td>
<td>Store Program Memory Read</td>
</tr>
<tr>
<td>TIMER0_COMPA_vect</td>
<td>Timer Counter 0 Compare Match A</td>
</tr>
<tr>
<td>TIMER0_COMPB_vect</td>
<td>Timer Counter 0 Compare Match B</td>
</tr>
<tr>
<td>TIMER0_OVF_vect</td>
<td>Timer/Counter 0 Overflow</td>
</tr>
<tr>
<td>TIMER1_CAPT_vect</td>
<td>Timer/Counter Capture Event</td>
</tr>
<tr>
<td>TIMER1_COMPA_vect</td>
<td>Timer Counter 1 Compare Match A</td>
</tr>
<tr>
<td>TIMER1_COMPB_vect</td>
<td>Timer Counter 1 Compare Match B</td>
</tr>
<tr>
<td>TIMER1_COMPC_vect</td>
<td>Timer Counter 1 Compare Match C</td>
</tr>
<tr>
<td>TIMER1_OVF_vect</td>
<td>Timer/Counter 1 Overflow</td>
</tr>
<tr>
<td>TIMER2_COMPA_vect</td>
<td>Timer Counter 2 Compare Match A</td>
</tr>
<tr>
<td>TIMER2_COMPB_vect</td>
<td>Timer Counter 2 Compare Match B</td>
</tr>
<tr>
<td>TIMER2_OVF_vect</td>
<td>Timer/Counter 2 Overflow</td>
</tr>
<tr>
<td>TIMER3_CAPT_vect</td>
<td>Timer/Counter Capture Event</td>
</tr>
<tr>
<td>TIMER3_COMPA_vect</td>
<td>Timer Counter 3 Compare Match A</td>
</tr>
<tr>
<td>TIMER3_COMPB_vect</td>
<td>Timer Counter 3 Compare Match B</td>
</tr>
<tr>
<td>TIMER3_COMPC_vect</td>
<td>Timer Counter 3 Compare Match C</td>
</tr>
<tr>
<td>TIMER3_OVF_vect</td>
<td>Timer/Counter 3 Overflow</td>
</tr>
<tr>
<td>TWI_vect</td>
<td>2-wire Serial Interface</td>
</tr>
<tr>
<td>USART1_RX_vect</td>
<td>USART1 rx complete</td>
</tr>
<tr>
<td>USART1_TX_vect</td>
<td>USART1 tx complete</td>
</tr>
<tr>
<td>USART1_UDRE_vect</td>
<td>USART1 Data register empty</td>
</tr>
<tr>
<td>WDT_vect</td>
<td>Watchdog Timout Interrupt</td>
</tr>
</tbody>
</table>
</details>
<details class="tip"><summary>Registers</summary><details class="success"><summary>Status I/O Register (SREG)</summary><h3 id="sreg">SREG<a class="headerlink" href="#sreg" title="Permanent link">⇦</a></h3>
<p>This register has 8 bits containing information about the current status of the microcontroller (specifically about the previous operation performed)</p>
<ul>
<li><strong>C</strong> Carry flag</li>
<li><strong>Z</strong> Zero flag</li>
<li><strong>N</strong> Negative flag</li>
<li><strong>V</strong> Two's complement overflow indicator</li>
<li><strong>S</strong> N xor V for signed tests</li>
<li><strong>H</strong> Half carry flag</li>
<li><strong>T</strong> Transfer bit used by BLD and BST Instructions</li>
<li><strong>I</strong> Global Interrupt Enable/Disable flag</li>
</ul>
</details>
<details class="success"><summary>Timer/Counter Register (TCNT0)</summary><h3 id="tcnt0">TCNT0<a class="headerlink" href="#tcnt0" title="Permanent link">⇦</a></h3>
<p>This register gives direct access to the timer/counter unit's 8-bit counter. Modifying this register while the counter is running may cause a Compare Match between TCNT0 and the OCR0x registers to be missed.</p>
</details>
<details class="success"><summary>Output Compare Register A (OCR0A)</summary><h3 id="ocr0a">OCR0A<a class="headerlink" href="#ocr0a" title="Permanent link">⇦</a></h3>
<p>The Output Compare Register A contains an 8-bit value that is continuously compared with the counter value (TCNT0). A match can be used to generate an Output Compare interrupt, or to generate a waveform output on the OC0A pin.</p>
</details>
<details class="success"><summary>Timer/Counter Interrupt Mask Register (TIMSK0)</summary><h3 id="timsk0">TIMSK0<a class="headerlink" href="#timsk0" title="Permanent link">⇦</a></h3>
<p>Enables compare and overflow interrupts for timer 0.</p>
<p>Bits 7-3 are reserved and always 0.</p>
<p>Bit 2 (<strong>OCIE0B</strong>) Enables the Compare Match B interrupt.</p>
<p>Bit 1 (<strong>OCIE0A</strong>) Enables the Compare Match A interrupt.</p>
<p>Bit 0 (<strong>TOIE0</strong>) Enables the overflow interrupt.</p>
<details class="tip"><summary>Even more info?</summary><ul>
<li><strong>Bit 2 – OCIE0B</strong> Timer/Counter Output Compare Match B Interrupt Enable When the OCIE0B bit is written to one, and the I-bit in the Status Register is set, the Timer/Counter Compare Match B interrupt is enabled. The corresponding interrupt is executed if a Compare Match in Timer/Counter occurs, that is, when the OCF0B bit is set in the Timer/Counter Interrupt Flag Register – TIFR0.</li>
<li><strong> Bit 1 – OCIE0A</strong> Timer/Counter0 Output Compare Match A Interrupt Enable When the OCIE0A bit is written to one, and the I-bit in the Status Register is set, the Timer/Counter0 Compare Match A interrupt is enabled. The corresponding interrupt is executed if a Compare Match in Timer/Counter0 occurs, that is, when the OCF0A bit is set in the Timer/Counter 0 Interrupt Flag Register – TIFR0.</li>
<li><strong> Bit 0 – TOIE0</strong> Timer/Counter0 Overflow Interrupt Enable When the TOIE0 bit is written to one, and the I-bit in the Status Register is set, the Timer/Counter0 Overflow interrupt is enabled. The corresponding interrupt is executed if an overflow in Timer/Counter0 occurs, that is, when the TOV0 bit is set in the Timer/Counter 0 Interrupt Flag Register – TIFR0.</li>
</ul>
</details>
</details>
<details class="success"><summary>Timer/Counter Control Register A (TCCR0A)</summary><h3 id="tccr0a">TCCR0A<a class="headerlink" href="#tccr0a" title="Permanent link">⇦</a></h3>
<p>Misc options for the timer/counter </p>
<ul>
<li>Bit 7 <strong>COMOA1</strong> Compare Match Output A Mode bit 1</li>
<li>Bit 6 <strong>COMOA0</strong> Compare Match Output A Mode bit 0</li>
<li>Bit 5 <strong>COMOB1</strong> Compare Match Output B mode bit 1</li>
<li>Bit 4 <strong>COMOB0</strong> Compare Match Output B mode bit 0</li>
<li>Bit 3 reserved</li>
<li>Bit 2 reserved</li>
<li>Bit 1 <strong>WGM01</strong>  Waveform Generation Mode bit 1</li>
<li>Bit 0 <strong>WGM00</strong>  Waveform Generation Mode bit 0</li>
</ul>
<table>
<thead>
<tr>
<th align="left">COM0X1</th>
<th align="left">COMOX0</th>
<th align="left">Behaviour</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">0</td>
<td align="left">0</td>
<td align="left">Normal port operation</td>
</tr>
<tr>
<td align="left">0</td>
<td align="left">1</td>
<td align="left"><strong>Non-PWM</strong> <br> Toggle OC0X on Compare Match <br> <strong>Fast-PWM</strong> <br> WGM02 = 0: Normal Port Operation, OC0X Disconnected.<br> WGM02 = 1: Toggle OC0X on Compare Match. <br> <strong>Phase-Correct PWM</strong> <br> WGM02 = 0: Normal Port Operation, OC0X Disconnected. <br> WGM02 = 1: Toggle OC0X on Compare Match.</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">0</td>
<td align="left"><strong>Non-PWM</strong> <br> Clear OC0X on Compare Match <br> <strong>Fast-PWM</strong>  <br> Clear OC0X on Compare Match, set OC0X at TOP <br> <strong>Phase-Correct PWM</strong> <br> Clear OC0X on Compare Match when up-counting. Set OC0X on Compare Match when down-counting.</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">1</td>
<td align="left"><strong>Non-PWM</strong> <br> Set OC0X on Compare Match <br> <strong>Fast-PWM</strong> <br> Set OC0X on Compare Match, clear OC0X at TOP <br> <strong>Phase-Correct PWM</strong> <br> Set OC0X on Compare Match when up-counting. Clear OC0X on Compare Match when down-counting.</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>WGM2</th>
<th>WGM1</th>
<th>WGM0</th>
<th>Mode of operation</th>
<th>TOP</th>
<th>Update OCRx at</th>
<th>TOV flag set on</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>Normal</td>
<td>OXFF</td>
<td>Immediate</td>
<td>MAX</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>PWM phase correct</td>
<td>0xFF</td>
<td>TOP</td>
<td>BOTTOM</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>CTC</td>
<td>OCRA</td>
<td>Immediate</td>
<td>MAX</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>Fast</td>
<td>PWM</td>
<td>0xFF</td>
<td>TOP</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>0</td>
<td>Reserved</td>
<td>–</td>
<td>–</td>
<td>–</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>1</td>
<td>PWM phase correct</td>
<td>OCRA</td>
<td>TOP</td>
<td>BOTTOM</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
<td>Reserved</td>
<td>–</td>
<td>–</td>
<td>–</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>Fast</td>
<td>PWM</td>
<td>OCRA</td>
<td>TOP</td>
</tr>
</tbody>
</table>
</details>
<details class="success"><summary>Timer/Counter 0 Interrupt Flag Register (TIFR0)</summary><h3 id="tifr0">TIFR0<a class="headerlink" href="#tifr0" title="Permanent link">⇦</a></h3>
<p>Indicates when the counter triggers a compare or overflow interrupt. </p>
<ul>
<li>Bits 7-3 are reserved and always 0.</li>
<li>Bit 2 <strong>OCF0B</strong> Timer/Counter 0 Output Compare B Match Flag</li>
<li>Bit 1 <strong>OCF0A</strong> Timer/Counter 0 Output Compare A Match Flag</li>
<li>Bit 0 <strong>TOV0</strong> Timer/Counter 0 Overflow Flag</li>
</ul>
<details class="tip"><summary>Even more info?</summary><ul>
<li>
<p><strong>Bit 2 – OCF0B</strong> Timer/Counter 0 Output Compare B Match Flag The OCF0B bit is set when a Compare Match occurs between the Timer/Counter and the data in OCR0B – Output Compare Register0 B. OCF0B is cleared by hardware when executing the corresponding interrupt handling vector. Alternatively,OCF0B is cleared by writing a logic one to the flag. When the I-bit in SREG, OCIE0B (Timer/Counter Compare B Match Interrupt Enable), and OCF0B are set, the Timer/Counter Compare Match Interrupt is executed.</p>
</li>
<li>
<p><strong>Bit 1 – OCF0A</strong> Timer/Counter 0 Output Compare A Match Flag The OCF0A bit is set when a Compare Match occurs between the Timer/Counter 0 and the data in OCR0A – Output Compare Register 0. OCF0A is cleared by hardware when executing the corresponding interrupt handling vector. Alternatively, OCF0A is cleared by writing a logic one to the flag. When the I-bit in SREG, OCIE0A (Timer/Counter 0 Compare Match Interrupt Enable), and OCF0A are set, the Timer/Counter 0 Compare Match Interrupt is executed.</p>
</li>
<li>
<p><strong>Bit 0 – TOV0</strong> Timer/Counter 0 Overflow Flag The bit TOV0 is set when an overflow occurs in Timer/Counter 0. TOV0 is cleared by hardware when executing the corresponding interrupt handling vector. Alternatively, TOV0 is cleared by writing a logic one to the flag. When the SREG I-bit, TOIE0 (Timer/Counter 0 Overflow Interrupt Enable), and TOV0 are set, the Timer/Counter 0 Overflow interrupt is executed.</p>
</li>
</ul>
<p>The setting of this flag is dependent on the WGM02:0 bit setting.</p>
</details>
</details>
<details class="success"><summary>Clock Prescale Register (CLKPR)</summary><h3 id="clkpr">CLKPR<a class="headerlink" href="#clkpr" title="Permanent link">⇦</a></h3>
<p>Controls how the system clock prescaler works.</p>
<ul>
<li>Bit 7 <strong>CLKPCE</strong> Write a 1 to this bit with 0 for all other bits to enable changes. This bit is cleared by hardware.</li>
<li>Bits 3-0 <strong>CLKPSX</strong> Division factor selector bits, see table below</li>
</ul>
<table>
<thead>
<tr>
<th>CLKPS3</th>
<th>CLKPS2</th>
<th>CLKPS1</th>
<th>CLKPS0</th>
<th>Clock</th>
<th>division</th>
<th>factor</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>4</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>8</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>16</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>32</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>64</td>
<td></td>
<td></td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>128</td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>256</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</details>
</details>
<details class="tip"><summary>Odd functions</summary><details class="success"><summary>sei()</summary><h3 id="sei">sei()<a class="headerlink" href="#sei" title="Permanent link">⇦</a></h3>
<p>This is used to enable global interrupts. Specifically it <strong>sets</strong> the <strong>I</strong> flag in SREG to 1.</p>
</details>
<details class="success"><summary>cli()</summary><h3 id="cli">cli()<a class="headerlink" href="#cli" title="Permanent link">⇦</a></h3>
<p>This is used to disable global interrupts. Specifically it <strong>clears</strong> the <strong>I</strong> flag in SREG to 0.</p>
</details>
</details>
<h2 id="unstructured-notes">Unstructured Notes<a class="headerlink" href="#unstructured-notes" title="Permanent link">⇦</a></h2>
<details class="question"><summary>Why are interrupts so weird?</summary><ul>
<li>C tries to stay away from machine specific details</li>
<li>This means each compiler has to handle interrupts it's own way</li>
<li>The most common approach for this is to use a vector table to direct interrupt requests</li>
<li>This still has problems though, such as needing to save registers and restore them later</li>
</ul>
<p>To enable saving registers and restoring later we need to tag the interrupt function with <code>__attribute__((signal))</code>. The <code>ISR()</code> macro does this for us and this is why we use it.</p>
</details>
<details class="question"><summary>Defining an interrupt routine</summary><ul>
<li>An interrupt routine is defined with <code>ISR()</code> (<strong>I</strong>nterrupt <strong>S</strong>ervice <strong>R</strong>outine)</li>
<li>This is a macro defined by the interrupt api (avr/interrupt.h)</li>
</ul>
<p>Here is an example of the ADC interrupt </p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;avr/interrupt.h&gt;</span><span class="cp"></span>
<span class="n">ISR</span><span class="p">(</span><span class="n">ADC_vect</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// user code here</span>
<span class="p">}</span>
</pre></div>

<p>If there is an unexpected interrupt (enabled but no handler) then the default action is to reset the device by jumping to the reset vector. You can catch this with the interrupt routine <code>BADISR_vect</code>.</p>
<div class="codehilite"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;avr/interrupt.h&gt;</span><span class="cp"></span>
<span class="n">ISR</span><span class="p">(</span><span class="n">BADISR_vect</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// user code here</span>
<span class="p">}</span>
</pre></div>

<p>AVR hardware clears the global interrupt flag in SREG before entering an interrupt vector, disabling other interrupts being called during execution. To allow interrupts to be embedded you can either use an <code>sei()</code> instruction at the beginning of the interrupt handler, or you can tell the compiler to do this for you by defining the interrupt handler like this.</p>
<div class="codehilite"><pre><span></span><span class="n">ISR</span><span class="p">(</span><span class="n">XXX_vect</span><span class="p">,</span> <span class="n">ISR_NOBLOCK</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></div>

<p>Sometimes interrupts share the exact same code. To allow multiple interrupts to execute this code we can use the <code>ISR_ALIASOF()</code> attribute.</p>
<div class="codehilite"><pre><span></span><span class="n">ISR</span><span class="p">(</span><span class="n">PCINT0_vect</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">...</span>
<span class="c1">// Code to handle the event.</span>
<span class="p">}</span>
<span class="n">ISR</span><span class="p">(</span><span class="n">PCINT1_vect</span><span class="p">,</span> <span class="n">ISR_ALIASOF</span><span class="p">(</span><span class="n">PCINT0_vect</span><span class="p">));</span>
</pre></div>

</details>
<details class="question"><summary>Enabling an interrupt</summary><p>The <strong>global interrupt enabled</strong> bit must be enabled for any interrupts to execute (see SREG). This is done simply by calling <code>sei()</code>.</p>
<p>Each interrupt is associated with 2 bits</p>
<ul>
<li><strong>Interrupt Flag Bit</strong> set when the interrupt occurs, regardless of if it is enabled or not, not really important</li>
<li><strong>Interrupt Enabled</strong> used to enable or disable an interrupt, this is what we want</li>
</ul>
<p>When <strong>both</strong> the <strong>Global Interrupt Enabled</strong> bit and the <strong>Interrupt Enabled</strong> bit are 1 then that interrupt will execute. Helpfully there is no general way to set the interrupt enabled bit and it is different for each one depending on which register needs to be used. Here is a quick cheat sheet on each interrupt.</p>
<details class="success"><summary>Enable interrupt cheat sheet</summary><table>
<thead>
<tr>
<th>Interrupt</th>
<th>Enable snippet</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADC_vect</td>
<td></td>
</tr>
<tr>
<td>ANALOG_COMP_vect</td>
<td></td>
</tr>
<tr>
<td>EE_READY_vect</td>
<td></td>
</tr>
<tr>
<td>INT0_vect</td>
<td></td>
</tr>
<tr>
<td>INT1_vect</td>
<td></td>
</tr>
<tr>
<td>INT2_vect</td>
<td></td>
</tr>
<tr>
<td>INT3_vect</td>
<td></td>
</tr>
<tr>
<td>INT4_vect</td>
<td></td>
</tr>
<tr>
<td>INT5_vect</td>
<td></td>
</tr>
<tr>
<td>INT6_vect</td>
<td></td>
</tr>
<tr>
<td>INT7_vect</td>
<td></td>
</tr>
<tr>
<td>PCINT0_vect</td>
<td></td>
</tr>
<tr>
<td>SPI_STC_vect</td>
<td></td>
</tr>
<tr>
<td>SPM_READY_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER0_COMPA_vect</td>
<td><code>TIMSK0 |= _BV(OCIE0A)</code></td>
</tr>
<tr>
<td>TIMER0_COMPB_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER0_OVF_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER1_CAPT_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER1_COMPA_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER1_COMPB_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER1_COMPC_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER1_OVF_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER2_COMPA_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER2_COMPB_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER2_OVF_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER3_CAPT_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER3_COMPA_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER3_COMPB_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER3_COMPC_vect</td>
<td></td>
</tr>
<tr>
<td>TIMER3_OVF_vect</td>
<td></td>
</tr>
<tr>
<td>TWI_vect</td>
<td></td>
</tr>
<tr>
<td>USART1_RX_vect</td>
<td></td>
</tr>
<tr>
<td>USART1_TX_vect</td>
<td></td>
</tr>
<tr>
<td>USART1_UDRE_vect</td>
<td></td>
</tr>
<tr>
<td>WDT_vect</td>
<td></td>
</tr>
</tbody>
</table>
</details>
</details>
<details class="question"><summary>How to use timers</summary><p>First of all there are three main things to consider</p>
<ul>
<li><strong>System clock</strong> this is the internal clock (8MHz)</li>
<li><strong>System Prescaler</strong> this divides the system clock to more manageable values and saves power, but this affects everything (CLKPR)</li>
<li><strong>Counter Prescaler</strong> this also divides the incoming clock to more more manageble values but only affects the counter ()</li>
</ul>
<p>The clock increments a counter (TCNTX) and when this counter hits a certain value (OCRXX) a compare match interrupt is executed. </p>
<p>We use a prescaler as the timer counter register is tiny! With only 8 bits we can only count 256 pulses, at 8Mhz this is only 0.03 ms!! With a prescaler we count a set number of pulses from the clock before passing a pulse on, extending the max time of the timer at the cost of resolution. The prescaler can divide the frequency by either 8, 64, 256 or 1024. If we used a prescaler with a value of 1024 then the max length of time we can use the timer for is now 32.6 ms. </p>
<p>A helpful formula for calculating this is <code>time = count_target / (clock / prescaler)</code></p>
<p>There are four timer modes</p>
<ul>
<li><strong>Normal mode</strong></li>
<li><strong>Clear Timer on Compare Match (CTC) mode</strong></li>
<li><strong>Fast PWM mode</strong></li>
<li><strong>Phase correct PWM mode</strong></li>
</ul>
</details>
<details class="question"><summary>16 bit in an 8 bit world?</summary><p>Some registers are 16 bits wide even though our data bus is only 8 bits. An example of this is Timer1 (and 3). The Timer/Counter (TCNTn), Output Compare Registers (OCRnA/B/C), and Input Capture Register (ICRn) are all 16-bit registers. Internally this is handled by a temporary 8 bit register which stores half the value during reads/writes. </p>
<p>When writing the high byte must be written first followed by the low byte. When reading the low byte must be read first then the high byte. The CPU handles copying into/from the temporary register for us. </p>
<div class="codehilite"><pre><span></span><span class="na">...</span>
<span class="c">; Set TCNTn to 0x01FF</span>
<span class="nf">ldi</span> <span class="no">r17</span><span class="p">,</span><span class="mi">0x01</span>
<span class="nf">ldi</span> <span class="no">r16</span><span class="p">,</span><span class="mi">0xFF</span>
<span class="nf">out</span> <span class="no">TCNTnH</span><span class="p">,</span><span class="no">r17</span>
<span class="nf">out</span> <span class="no">TCNTnL</span><span class="p">,</span><span class="no">r16</span>
<span class="c">; Read TCNTn into r17:r16</span>
<span class="nf">in</span> <span class="no">r16</span><span class="p">,</span><span class="no">TCNTnL</span>
<span class="nf">in</span> <span class="no">r17</span><span class="p">,</span><span class="no">TCNTnH</span>
<span class="na">...</span>
</pre></div>

<p>Luckily when using C this is all abstracted away by the compiler so we can simply read and write like normal.</p>
<div class="codehilite"><pre><span></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="p">...</span>
<span class="cm">/* Set TCNTn to 0x01FF */</span>
<span class="n">TCNTn</span> <span class="o">=</span> <span class="mh">0x1FF</span><span class="p">;</span>
<span class="cm">/* Read TCNTn into i */</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">TCNTn</span><span class="p">;</span>
<span class="p">...</span>
</pre></div>

</details>
<details class="tip"><summary>Sources</summary><ul>
<li><strong>About interrupts</strong> https://www.nongnu.org/avr-libc/user-manual/group__avr__interrupts.html</li>
<li><strong>About interrupt vector tables</strong> https://en.wikipedia.org/wiki/Interrupt_vector_table</li>
<li><strong>AVR interrupt vectors</strong> https://www.microchip.com/webdoc/AVRLibcReferenceManual/group__avr__interrupts.html</li>
<li><strong>More about interrupts</strong> http://www.avr-tutorials.com/interrupts/about-avr-8-bit-microcontrollers-interrupts</li>
<li><strong>SREG info</strong> http://ww1.microchip.com/downloads/en/devicedoc/atmel-0856-avr-instruction-set-manual.pdf</li>
<li><strong>Timer info</strong> https://sites.google.com/site/qeewiki/books/avr-guide/common-timer-theory</li>
</ul>
</details>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="BodyBuilding.html" title="Body Building and general nutrition" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Body Building and general nutrition
              </span>
            </div>
          </a>
        
        
          <a href="DistributedSystemsAndNetworks.html" title="Distributed Systems & Networks" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Distributed Systems & Networks
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/application.dc02f8ce.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>